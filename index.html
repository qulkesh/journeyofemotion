<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Journey of Emotion</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzg5NTVGNCIvPgo8cGF0aCBkPSJNMTYgMTBIMTJDMTAuODk1NCAxMCAxMCAxMC44OTU0IDEwIDEyVjIwQzEwIDIxLjEwNDYgMTAuODk1NCAyMiAxMiAyMkgyMEMyMS4xMDQ2IDIyIDIyIDIxLjEwNDYgMjIgMjBWMTZIMjBWMjBIMTJWMTJIMTZWMTBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTkgN0MxOC40NDc3IDcgMTggNy40NDc3MiAxOCA4QzE4IDguNTUyMjggMTguNDQ3NyA5IDE5IDlIMjFWMTFDMjEgMTEuNTUyMyAyMS40NDc3IDEyIDIyIDEyQzIyLjU1MjMgMTIgMjMgMTEuNTUyMyAyMyAxMVY5SDI1QzI1LjU1MjMgOSAyNiA4LjU1MjI4IDI2IDhDMjYgNy40NDc3MiAyNS41NTIzIDcgMjUgN0gyM1Y1QzIzIDQuNDQ3NzIgMjIuNTUyMyA0IDIyIDRDMjEuNDQ3NyA0IDIxIDQuNDQ3NzIgMjEgNVY3SDE5WiIgZmlsbD0id2hpdGUiLz4KPHN2Zz4=">
    
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#8b5cf6">
    <meta name="description" content="–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ, —Ä–∞–∑–º—ã—à–ª—è–π—Ç–µ –∏ –ø–æ–Ω–∏–º–∞–π—Ç–µ —Å–≤–æ–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let app, db, auth;
        window.currentUser = null;
        window.firebaseInitialized = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase
        async function loadFirebaseConfig() {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase...');
                
                // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Netlify Function
                const response = await fetch('/.netlify/functions/firebase-config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const config = await response.json();
                
                if (!config.apiKey || !config.projectId) {
                    throw new Error('–ù–µ–ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase');
                }

                console.log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                return config;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase:', error);
                
                // Fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è localhost)
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.warn('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è demo –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏');
                    return {
                        apiKey: "demo-key-for-development",
                        authDomain: "demo-project.firebaseapp.com",
                        projectId: "demo-project",
                        storageBucket: "demo-project.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "demo-app-id"
                    };
                }
                
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        async function initializeFirebase() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                const firebaseConfig = await loadFirebaseConfig();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                window.firebaseInitialized = true;
                
                console.log('Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                updateConnectionStatus('online', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                document.getElementById('userStatus').textContent = '‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        window.currentUser = user;
                        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.uid);
                        hideAuthModal();
                        updateUserStatus(user);
                        updateAuthUI(true);
                        
                        if (window.loadUserData) {
                            window.loadUserData();
                        }
                    } else {
                        window.currentUser = null;
                        showAuthModal();
                        updateAuthUI(false);
                        document.getElementById('userStatus').textContent = 'üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
                    }
                });

                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
                window.firebaseInitialized = false;
                updateConnectionStatus('offline', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                document.getElementById('userStatus').textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
                showFirebaseError(error.message);
                return false;
            }
        }

        function showFirebaseError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <strong class="font-bold">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!</strong>
                        <span class="block sm:inline"> ${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700">
                        ‚úï
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        function updateAuthUI(isLoggedIn) {
            const headerLoginBtn = document.getElementById('headerLoginBtn');
            
            if (isLoggedIn) {
                headerLoginBtn.innerHTML = 'üö™';
                headerLoginBtn.title = '–í—ã–π—Ç–∏';
                headerLoginBtn.onclick = signOutUser;
            } else {
                headerLoginBtn.innerHTML = 'üîë';
                headerLoginBtn.title = '–í–æ–π—Ç–∏';
                headerLoginBtn.onclick = showAuthModal;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function signUpUser(email, password, displayName) {
            if (!window.firebaseInitialized) {
                throw new Error('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: displayName });
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', userCredential.user.uid);
            } catch (error) {
                throw error;
            }
        }

        async function signInUser(email, password) {
            if (!window.firebaseInitialized) {
                throw new Error('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', userCredential.user.uid);
            } catch (error) {
                throw error;
            }
        }

        async function signOutUser() {
            if (!window.firebaseInitialized) {
                return;
            }
            
            try {
                await auth.signOut();
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª');
                entries = [];
                showView('log');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            }
        }

        function updateUserStatus(user) {
            const displayName = user.displayName || user.email.split('@')[0];
            document.getElementById('userStatus').textContent = `üë§ ${displayName}`;
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('show');
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π –∫–æ–¥–∞
        window.signUpUser = signUpUser;
        window.signInUser = signInUser;
        window.signOutUser = signOutUser;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
            const firebaseReady = await initializeFirebase();
            
            // –ó–∞—Ç–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            if (window.initApp) {
                window.initApp();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å Firebase –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            const firebaseStatus = document.getElementById('firebaseStatus');
            if (firebaseStatus) {
                if (firebaseReady) {
                    firebaseStatus.innerHTML = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Firebase';
                } else {
                    firebaseStatus.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase';
                }
            }
        });
    </script>

    <style>
        :root {
            --primary-color: #8b5cf6;
            --primary-hover: #7c3aed;
            --secondary-color: #ec4899;
            --bg-from: #f3e8ff;
            --bg-via: #fdf2f8;
            --bg-to: #dbeafe;
        }

        .theme-purple {
            --primary-color: #8b5cf6;
            --primary-hover: #7c3aed;
            --secondary-color: #ec4899;
            --bg-from: #f3e8ff;
            --bg-via: #fdf2f8;
            --bg-to: #dbeafe;
        }

        .theme-blue {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #06b6d4;
            --bg-from: #dbeafe;
            --bg-via: #f0f9ff;
            --bg-to: #cffafe;
        }

        .theme-green {
            --primary-color: #10b981;
            --primary-hover: #059669;
            --secondary-color: #34d399;
            --bg-from: #d1fae5;
            --bg-via: #ecfdf5;
            --bg-to: #f0fdf4;
        }

        .theme-orange {
            --primary-color: #f59e0b;
            --primary-hover: #d97706;
            --secondary-color: #fb923c;
            --bg-from: #fef3c7;
            --bg-via: #fffbeb;
            --bg-to: #ffedd5;
        }

        .theme-rose {
            --primary-color: #e11d48;
            --primary-hover: #be185d;
            --secondary-color: #f43f5e;
            --bg-from: #fecdd3;
            --bg-via: #fff1f2;
            --bg-to: #ffe4e6;
        }

        body {
            background: linear-gradient(to bottom right, var(--bg-from), var(--bg-via), var(--bg-to));
        }

        .primary-bg {
            background-color: var(--primary-color);
        }

        .primary-hover:hover {
            background-color: var(--primary-hover);
        }

        .primary-border {
            border-color: var(--primary-color);
        }

        .primary-text {
            color: var(--primary-color);
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem;
            }
            .mobile-nav {
                flex-direction: row;
                gap: 0.25rem;
            }
            .mobile-nav button {
                flex: 1;
                text-align: center;
                font-size: 0.75rem;
                padding: 0.5rem 0.25rem;
            }
            body {
                padding: 0.5rem;
            }
            .max-w-4xl {
                padding: 0;
            }
        }

        /* Touch improvements */
        button {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        input, textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-btn {
            padding: 0.5rem;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.5rem;
            text-align: center;
            transition: all 0.2s;
        }

        .emoji-btn:hover {
            border-color: var(--primary-color);
            background-color: rgba(139, 92, 246, 0.1);
        }

        .emoji-btn.selected {
            border-color: var(--primary-color);
            background-color: rgba(139, 92, 246, 0.2);
        }

        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-btn.active {
            border-color: #374151;
            transform: scale(1.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            z-index: 9999;
        }

        .online {
            background: #10b981 !important;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div id="connectionStatus" class="offline-indicator" style="display: none;">
        üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
    </div>

    <div class="max-w-4xl mx-auto p-4">
        <!-- Header -->
        <div class="text-center mb-6 pt-4">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showThemeSelector()" class="p-2 rounded-full bg-white shadow-lg hover:shadow-xl transition-all">
                    üé®
                </button>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Journey of Emotion</h1>
                <div class="flex space-x-2">
                    <button onclick="showView('settings')" class="p-2 rounded-full bg-white shadow-lg hover:shadow-xl transition-all">
                        ‚öôÔ∏è
                    </button>
                    <button id="headerLoginBtn" onclick="showAuthModal()" class="p-2 rounded-full bg-white shadow-lg hover:shadow-xl transition-all" title="–í–æ–π—Ç–∏">
                        üîë
                    </button>
                </div>
            </div>
            <p class="text-gray-600 text-sm md:text-base px-4">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ, —Ä–∞–∑–º—ã—à–ª—è–π—Ç–µ –∏ –ø–æ–Ω–∏–º–∞–π—Ç–µ —Å–≤–æ–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</p>
            <div class="text-xs text-gray-500 mt-2">
                <span id="userStatus">üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-full p-1 shadow-lg mobile-nav w-full max-w-md flex">
                <button onclick="showView('log')" id="logBtn" class="flex-1 px-4 py-2 rounded-full transition-all primary-bg text-white shadow-md text-sm">
                    ‚ûï –ó–∞–ø–∏—Å–∞—Ç—å
                </button>
                <button onclick="showView('history')" id="historyBtn" class="flex-1 px-4 py-2 rounded-full transition-all text-gray-600 hover:bg-gray-100 text-sm">
                    üìÖ –ò—Å—Ç–æ—Ä–∏—è
                </button>
                <button onclick="showView('insights')" id="insightsBtn" class="flex-1 px-4 py-2 rounded-full transition-all text-gray-600 hover:bg-gray-100 text-sm">
                    üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </button>
            </div>
        </div>

        <!-- Log View -->
        <div id="logView" class="bg-white rounded-2xl shadow-xl p-4 md:p-8 mx-2 md:max-w-2xl md:mx-auto">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4 md:mb-6 text-center">–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ?</h2>
            
            <!-- Emotion Selection -->
            <div class="mb-4 md:mb-6">
                <div class="flex justify-between items-center mb-3 md:mb-4">
                    <h3 class="text-base md:text-lg font-medium text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é:</h3>
                    <button onclick="showAddEmotionModal()" class="text-sm primary-text hover:underline">
                        + –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é
                    </button>
                </div>
                <div id="emotionGrid" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3 mobile-grid">
                    <!-- Emotions will be rendered here -->
                </div>
            </div>

            <!-- Intensity Slider -->
            <div id="intensitySection" class="mb-4 md:mb-6 hidden">
                <h3 class="text-base md:text-lg font-medium text-gray-700 mb-3 md:mb-4">
                    –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: <span id="intensityValue">5</span>/10
                </h3>
                <input type="range" min="1" max="10" value="5" id="intensitySlider" 
                       class="w-full h-3 md:h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                <div class="flex justify-between text-xs md:text-sm text-gray-500 mt-1">
                    <span>–°–ª–∞–±–æ</span>
                    <span>–°–∏–ª—å–Ω–æ</span>
                </div>
            </div>

            <!-- Trigger Input -->
            <div id="triggerSection" class="mb-4 md:mb-6 hidden">
                <h3 class="text-base md:text-lg font-medium text-gray-700 mb-2">–ß—Ç–æ –≤—ã–∑–≤–∞–ª–æ —ç—Ç—É —ç–º–æ—Ü–∏—é?</h3>
                <input type="text" id="triggerInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å—Ç—Ä–µ—á–∞ –Ω–∞ —Ä–∞–±–æ—Ç–µ, —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –¥—Ä—É–≥–æ–º..." 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm md:text-base">
            </div>

            <!-- Note Input -->
            <div id="noteSection" class="mb-4 md:mb-6 hidden">
                <h3 class="text-base md:text-lg font-medium text-gray-700 mb-2">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</h3>
                <textarea id="noteInput" placeholder="–ö–∞–∫ –æ—â—É—â–∞–ª–∞—Å—å —ç—Ç–∞ —ç–º–æ—Ü–∏—è? –ö–∞–∫–∏–µ –º—ã—Å–ª–∏ —Å –Ω–µ–π –ø—Ä–∏—à–ª–∏?" 
                          rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm md:text-base resize-none"></textarea>
            </div>

            <!-- Submit Button -->
            <button id="saveBtn" onclick="saveEntry()" class="w-full primary-bg primary-hover text-white py-3 md:py-3 rounded-lg transition-colors font-medium shadow-lg hidden text-sm md:text-base">
                <span id="saveText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</span>
                <span id="saveLoader" class="loading hidden"></span>
            </button>
        </div>

        <!-- History View -->
        <div id="historyView" class="bg-white rounded-2xl shadow-xl p-4 md:p-8 mx-2 hidden">
            <div class="flex justify-between items-center mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-semibold text-gray-800">–í–∞—à–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</h2>
                <button onclick="refreshHistory()" class="text-sm primary-text hover:underline">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            <div id="historyContent">
                <div class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-500">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ –∑–∞–ø–∏—Å–∏...</p>
                </div>
            </div>
        </div>

        <!-- Insights View -->
        <div id="insightsView" class="bg-white rounded-2xl shadow-xl p-4 md:p-8 mx-2 hidden">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4 md:mb-6">–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <div id="insightsContent">
                <div class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-500">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...</p>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="bg-white rounded-2xl shadow-xl p-4 md:p-8 mx-2 hidden">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4 md:mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <div class="space-y-6">
                <!-- Firebase Status -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
                    <div id="firebaseStatus" class="text-sm text-gray-600">
                        <div class="loading inline-block mr-2"></div>
                        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
                    </div>
                </div>

                <!-- Theme Selection -->
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-3">–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞</h3>
                    <div class="flex space-x-3">
                        <button onclick="changeTheme('purple')" class="theme-btn theme-purple" style="background: linear-gradient(45deg, #8b5cf6, #ec4899)" data-theme="purple"></button>
                        <button onclick="changeTheme('blue')" class="theme-btn theme-blue" style="background: linear-gradient(45deg, #3b82f6, #06b6d4)" data-theme="blue"></button>
                        <button onclick="changeTheme('green')" class="theme-btn theme-green" style="background: linear-gradient(45deg, #10b981, #34d399)" data-theme="green"></button>
                        <button onclick="changeTheme('orange')" class="theme-btn theme-orange" style="background: linear-gradient(45deg, #f59e0b, #fb923c)" data-theme="orange"></button>
                        <button onclick="changeTheme('rose')" class="theme-btn theme-rose" style="background: linear-gradient(45deg, #e11d48, #f43f5e)" data-theme="rose"></button>
                    </div>
                </div>

                <!-- Custom Emotions Management -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-medium text-gray-700">–í–∞—à–∏ —ç–º–æ—Ü–∏–∏</h3>
                        <button onclick="showAddEmotionModal()" class="primary-bg primary-hover text-white px-4 py-2 rounded-lg text-sm">
                            –î–æ–±–∞–≤–∏—Ç—å —ç–º–æ—Ü–∏—é
                        </button>
                    </div>
                    <div id="customEmotionsList" class="space-y-2">
                        <!-- Custom emotions will be listed here -->
                    </div>
                </div>

                <!-- Data Management -->
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                    <div class="space-y-2">
                        <button onclick="exportData()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm">
                            üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                        </button>
                        <button onclick="syncData()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg text-sm">
                            üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Psychology Tips Section -->
        <div class="mt-8 bg-white rounded-2xl shadow-xl p-4 md:p-6 mx-2">
            <div class="text-center mb-4">
                <h3 class="text-lg md:text-xl font-semibold text-gray-800 mb-2">üí° –°–æ–≤–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∞</h3>
                <div id="psychologyTip" class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg">
                    <p id="tipText" class="text-gray-700 text-sm md:text-base italic mb-2">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–≤–µ—Ç...</p>
                    <p id="tipAuthor" class="text-gray-600 text-xs md:text-sm">‚Äî</p>
                </div>
                <div class="mt-3 flex justify-center space-x-2">
                    <button onclick="loadNewTip()" class="primary-bg primary-hover text-white px-4 py-2 rounded-lg text-sm">
                        –ù–æ–≤—ã–π —Å–æ–≤–µ—Ç
                    </button>
                    <div class="flex items-center text-xs text-gray-500">
                        <span id="countdown">30</span>s
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal show">
        <div class="bg-white rounded-2xl p-6 m-4 max-w-md w-full">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Journey of Emotion</h2>
                <p class="text-gray-600">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–≤–æ–∏ —ç–º–æ—Ü–∏–∏ –≤ –æ–±–ª–∞–∫–µ</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <h3 class="text-lg font-semibold mb-4">–í—Ö–æ–¥</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <button onclick="handleLogin()" class="w-full primary-bg primary-hover text-white py-3 rounded-lg font-medium">
                        <span id="loginText">–í–æ–π—Ç–∏</span>
                        <span id="loginLoader" class="loading hidden"></span>
                    </button>
                </div>

                <div class="text-center">
                    <button onclick="showRegisterForm()" class="text-sm primary-text hover:underline">
                        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </button>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h3 class="text-lg font-semibold mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ò–º—è</label>
                    <input type="text" id="registerName" placeholder="–í–∞—à–µ –∏–º—è" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <button onclick="handleRegister()" class="w-full primary-bg primary-hover text-white py-3 rounded-lg font-medium">
                        <span id="registerText">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
                        <span id="registerLoader" class="loading hidden"></span>
                    </button>
                </div>

                <div class="text-center">
                    <button onclick="showLoginForm()" class="text-sm primary-text hover:underline">
                        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏
                    </button>
                </div>
            </div>

            <!-- Error Message -->
            <div id="authError" class="mt-4 p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm hidden">
                <span id="authErrorText"></span>
            </div>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div id="themeModal" class="modal">
        <div class="bg-white rounded-2xl p-6 m-4 max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</h3>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="changeTheme('purple')" class="theme-btn mx-auto theme-purple" style="background: linear-gradient(45deg, #8b5cf6, #ec4899)" data-theme="purple"></button>
                <button onclick="changeTheme('blue')" class="theme-btn mx-auto theme-blue" style="background: linear-gradient(45deg, #3b82f6, #06b6d4)" data-theme="blue"></button>
                <button onclick="changeTheme('green')" class="theme-btn mx-auto theme-green" style="background: linear-gradient(45deg, #10b981, #34d399)" data-theme="green"></button>
                <button onclick="changeTheme('orange')" class="theme-btn mx-auto theme-orange" style="background: linear-gradient(45deg, #f59e0b, #fb923c)" data-theme="orange"></button>
                <button onclick="changeTheme('rose')" class="theme-btn mx-auto theme-rose" style="background: linear-gradient(45deg, #e11d48, #f43f5e)" data-theme="rose"></button>
            </div>
            <button onclick="closeThemeModal()" class="w-full bg-gray-200 text-gray-800 py-2 rounded-lg">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <!-- Add Emotion Modal -->
    <div id="addEmotionModal" class="modal">
        <div class="bg-white rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —ç–º–æ—Ü–∏—é</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —ç–º–æ—Ü–∏–∏</label>
                <input type="text" id="emotionNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏</label>
                <div class="emoji-grid" id="emojiGrid">
                    <!-- Emojis will be generated here -->
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±—Ä–∞–Ω–Ω–∞—è —ç–º–æ—Ü–∏—è</label>
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div id="selectedEmojiPreview" class="w-8 h-8 flex items-center justify-center text-2xl">‚ùì</div>
                    <span id="selectedEmotionNamePreview" class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</span>
                </div>
            </div>

            <div class="flex space-x-3">
                <button onclick="addCustomEmotion()" class="flex-1 primary-bg primary-hover text-white py-2 rounded-lg">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
                <button onclick="closeAddEmotionModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        // Application data
        let entries = [];
        let selectedEmotion = '';
        let currentTheme = localStorage.getItem('selectedTheme') || 'purple';
        let selectedEmoji = '';
        let isOnline = navigator.onLine;

        // Default emotions
        const defaultEmotions = {
            joy: { name: '–†–∞–¥–æ—Å—Ç—å', color: 'bg-yellow-400', emoji: '‚òÄÔ∏è', isDefault: true },
            love: { name: '–õ—é–±–æ–≤—å', color: 'bg-pink-400', emoji: '‚ù§Ô∏è', isDefault: true },
            excitement: { name: '–í–æ–ª–Ω–µ–Ω–∏–µ', color: 'bg-orange-400', emoji: '‚ö°', isDefault: true },
            calm: { name: '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ', color: 'bg-blue-400', emoji: '‚òÅÔ∏è', isDefault: true },
            neutral: { name: '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ', color: 'bg-gray-400', emoji: 'üòê', isDefault: true },
            sadness: { name: '–ì—Ä—É—Å—Ç—å', color: 'bg-blue-600', emoji: 'üåßÔ∏è', isDefault: true },
            anger: { name: '–ì–Ω–µ–≤', color: 'bg-red-500', emoji: 'üò†', isDefault: true },
            anxiety: { name: '–¢—Ä–µ–≤–æ–≥–∞', color: 'bg-purple-500', emoji: 'üò∞', isDefault: true }
        };

        // Load custom emotions
        let customEmotions = JSON.parse(localStorage.getItem('customEmotions')) || {};
        let emotions = { ...defaultEmotions, ...customEmotions };

        // Available emojis for selection
        const availableEmojis = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£',
            'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
            'üòò', 'üòó', '‚ò∫Ô∏è', 'üòö', 'üòô', 'ü•≤', 'üòã', 'üòõ',
            'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î',
            'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ',
            'üò¨', 'ü§•', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í',
            'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ',
            'ü§Ø', 'ü§†', 'ü•≥', 'ü•∏', 'üòé', 'ü§ì', 'üßê', 'üòï',
            'üòü', 'üôÅ', '‚òπÔ∏è', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫',
            'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±',
            'üòñ', 'üò£', 'üòû', 'üòì', 'üò©', 'üò´', 'ü•±', 'üò§',
            'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø', 'üíÄ', '‚ò†Ô∏è', 'üí©',
            'ü§°', 'üëπ', 'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ', 'üé≠',
            'üí´', '‚≠ê', 'üåü', '‚ú®', '‚ö°', 'üí•', 'üí¢', 'üíØ',
            'üí§', 'üí®', 'ü§ç', 'üñ§', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö',
            'üíô', 'üíú', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì',
            'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è',
            'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê'
        ];

        // Helper function to safely convert dates
        function safeTimestamp(dateValue) {
            if (!dateValue) return new Date();
            
            if (dateValue instanceof Date) {
                return dateValue;
            }
            
            // Handle Firebase Timestamp
            if (dateValue && typeof dateValue.toDate === 'function') {
                return dateValue.toDate();
            }
            
            // Handle string or number
            try {
                const date = new Date(dateValue);
                return isNaN(date.getTime()) ? new Date() : date;
            } catch (error) {
                console.warn('Invalid date value:', dateValue);
                return new Date();
            }
        }

        // Firebase functions with enhanced error handling
        async function saveEntryToFirebase(entry) {
            if (!window.firebaseInitialized || !window.currentUser || !db) {
                throw new Error('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }

            try {
                const docRef = await db.collection('users')
                    .doc(window.currentUser.uid)
                    .collection('emotions')
                    .add({
                        ...entry,
                        userId: window.currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        timestamp: firebase.firestore.Timestamp.fromDate(entry.timestamp)
                    });
                console.log('–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                throw error;
            }
        }

        async function loadEntriesFromFirebase() {
            if (!window.firebaseInitialized || !window.currentUser || !db) {
                return [];
            }

            try {
                const snapshot = await db.collection('users')
                    .doc(window.currentUser.uid)
                    .collection('emotions')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const firebaseEntries = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    firebaseEntries.push({
                        id: data.id || doc.id,
                        firebaseId: doc.id,
                        ...data,
                        timestamp: safeTimestamp(data.timestamp || data.createdAt)
                    });
                });
                
                return firebaseEntries;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                return [];
            }
        }

        async function deleteEntryFromFirebase(entryId) {
            if (!window.firebaseInitialized || !window.currentUser || !db) {
                throw new Error('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }

            try {
                const entry = entries.find(e => e.id == entryId || e.firebaseId == entryId);
                const docId = entry ? (entry.firebaseId || entry.id) : entryId;
                
                await db.collection('users')
                    .doc(window.currentUser.uid)
                    .collection('emotions')
                    .doc(docId)
                    .delete();
                    
                console.log('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞ –∏–∑ Firebase:', docId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Firebase:', error);
                throw error;
            }
        }

        // User data loading function
        window.loadUserData = async function() {
            try {
                if (!window.firebaseInitialized) {
                    throw new Error('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }
                
                updateConnectionStatus('online', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                document.getElementById('userStatus').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –æ–±–ª–∞–∫—É';
                
                const firebaseEntries = await loadEntriesFromFirebase();
                const localEntries = JSON.parse(localStorage.getItem('emotionEntries')) || [];
                
                entries = firebaseEntries.length > 0 ? firebaseEntries : localEntries;
                
                // Ensure all entries have valid timestamps
                entries = entries.map(entry => ({
                    ...entry,
                    timestamp: safeTimestamp(entry.timestamp)
                }));
                
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${entries.length} –∑–∞–ø–∏—Å–µ–π`);
                
                const currentView = getCurrentView();
                if (currentView === 'history') {
                    displayHistory();
                } else if (currentView === 'insights') {
                    displayInsights();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                updateConnectionStatus('offline', '–†–∞–±–æ—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω');
                document.getElementById('userStatus').textContent = '‚ö†Ô∏è –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
                
                // Load local data with safe timestamps
                const localEntries = JSON.parse(localStorage.getItem('emotionEntries')) || [];
                entries = localEntries.map(entry => ({
                    ...entry,
                    timestamp: safeTimestamp(entry.timestamp)
                }));
            }
        };

        // Connection monitoring
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connectionStatus');
            const firebaseStatus = document.getElementById('firebaseStatus');
            
            if (status === 'online') {
                indicator.className = 'offline-indicator online';
                indicator.textContent = 'üåê –û–Ω–ª–∞–π–Ω';
                if (firebaseStatus) {
                    firebaseStatus.innerHTML = '‚úÖ ' + message;
                }
                isOnline = true;
            } else {
                indicator.className = 'offline-indicator';
                indicator.textContent = 'üì¥ –û—Ñ—Ñ–ª–∞–π–Ω';
                if (firebaseStatus) {
                    firebaseStatus.innerHTML = '‚ö†Ô∏è ' + message;
                }
                isOnline = false;
            }
            
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // Network event listeners
        window.addEventListener('online', () => {
            updateConnectionStatus('online', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            if (window.currentUser) {
                syncData();
            }
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus('offline', '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
        });

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—á–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–µ—Ä—Å–∏—è–º...
        // –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ–ø—É—â–µ–Ω—ã, –Ω–æ –≤–∫–ª—é—á–∞—é—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞

        // Core application functions
        function getCurrentView() {
            if (!document.getElementById('logView').classList.contains('hidden')) return 'log';
            if (!document.getElementById('historyView').classList.contains('hidden')) return 'history';
            if (!document.getElementById('insightsView').classList.contains('hidden')) return 'insights';
            if (!document.getElementById('settingsView').classList.contains('hidden')) return 'settings';
            return 'log';
